#!/usr/sbin/nft -f

#sudo nft -f /etc/nftables.conf       # Charger la config
#sudo systemctl enable nftables       # Activer au démarrage
#sudo systemctl start nftables        # Démarrer le service
#sudo nft list ruleset                # Vérifier les règles


####################################
# 1. IPv6 ONLY
####################################
table ip6 filter {
    chain input {
        type filter hook input priority 0; policy drop;

        # Loopback
        iif lo accept

        # Connexions établies / liées
        ct state established,related accept

        # Link-local IPv6 (INDISPENSABLE)
        ip6 saddr fe80::/10 accept

        # SSH depuis préfixe IPv6 spécifique
        ip6 saddr wwww:xxxx:yyyy:zzzz::/64 tcp dport 22 ct state new limit rate 5/second accept                

        # HTTP/HTTPS pour Caddy / Let's Encrypt
        tcp dport 80 accept
        tcp dport 443 accept

        # ICMPv6 minimal
        icmpv6 type { 
            echo-request, 
            nd-neighbor-solicit, 
            nd-neighbor-advert, 
            nd-router-solicit, 
            nd-router-advert 
        } accept

        # Logging pour paquets rejetés
        log prefix "IPV6 DROP: " flags all counter
    }

    chain output {
        type filter hook output priority 0; policy accept;
    }

    chain forward {
        type filter hook forward priority 0; policy drop;
    }
}

####################################
# 2. IPv4 ONLY
####################################
table ip filter {
    chain input {
        type filter hook input priority 0; policy drop;

        # Loopback
        iif lo accept

        # Connexions établies / liées
        ct state established,related accept

        # SSH depuis le pool IPv4 192.168.1.0/24
        ip saddr 192.168.1.0/24 tcp dport 22 ct state new limit rate 5/second accept

        # HTTP/HTTPS pour Caddy
        tcp dport 80 accept
        tcp dport 443 accept

        # ICMPv4 minimal (ping)
        icmp type echo-request accept

        # Logging pour paquets rejetés
        log prefix "IPV4 DROP: " flags all counter
    }

    chain output {
        type filter hook output priority 0; policy accept;
    }

    chain forward {
        type filter hook forward priority 0; policy drop;
    }
}
